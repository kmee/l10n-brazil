<?xml version="1.0" encoding="utf-8" ?>
<!-- Copyright 2020 KMEE -->
<!-- License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl). -->
<odoo>

    <template
        id="assets_frontend"
        name="payment_pagseguro assets"
        inherit_id="web.assets_frontend"
    >
        <xpath expr="." position="inside">
            <script
                type="text/javascript"
                src="/payment_pagseguro/static/src/js/pagseguro_tokenize_card.js"
            />
        </xpath>
    </template>

    <template
        id="assets_common"
        name="Payment Pagseguro Assets Common"
        inherit_id="web.assets_common"
    >
        <xpath expr="." position="inside">
            <script
                type="text/javascript"
                src="/payment_pagseguro/static/src/js/pagseguro_tour.js"
            />
        </xpath>
    </template>


    <data noupdate="1">
        <template id="pagseguro_form">
            <div>
                <input
                    type="hidden"
                    name="data_set"
                    t-att-data-action-url="tx_url"
                    data-remove-me=""
                />
                <input type="hidden" name='x_login' t-att-value='x_login' />
                <input type="hidden" name='x_fp_hash' t-att-value='x_fp_hash' />
                <input type="hidden" name='x_amount' t-att-value='x_amount' />
                <input type="hidden" name='x_show_form' t-att-value="x_show_form" />
                <input type="hidden" name='x_type' t-att-value="x_type" />
                <input type="hidden" name='x_method' t-att-value="x_method" />
                <input type="hidden" name='x_fp_sequence' t-att-value='x_fp_sequence' />
                <input type="hidden" name='x_version' t-att-value="x_version" />
                <input
                    type="hidden"
                    name="x_relay_response"
                    t-att-value="x_relay_response"
                />
                <input type="hidden" name="x_relay_url" t-att-value="x_relay_url" />
                <input
                    type="hidden"
                    name="x_fp_timestamp"
                    t-att-value="x_fp_timestamp"
                />
                <input type="hidden" name='return_url' t-att-value="returndata" />
                <input type="hidden" name='x_cancel_url' t-att-value="x_cancel_url" />
                <!--Order Information -->
                <input type="hidden" name='x_invoice_num' t-att-value='reference' />
                <input
                    type="hidden"
                    name='x_currency_code'
                    t-att-value='x_currency_code'
                />
                <!-- Billing Information-->
                <input
                    type="hidden"
                    name='x_first_name'
                    t-att-value="billing_first_name"
                />
                <input
                    type="hidden"
                    name='x_last_name'
                    t-att-value="billing_last_name"
                />
                <input
                    type="hidden"
                    name="x_company"
                    t-att-value="billing_partner_commercial_company_name"
                />
                <input type="hidden" name='x_address' t-att-value="billing_address" />
                <input type="hidden" name='x_city' t-att-value="billing_city" />
                <input type="hidden" name='x_zip' t-att-value="billing_zip_code" />
                <input type="hidden" name='x_country' t-att-value="billing_country" />
                <input type="hidden" name='x_phone' t-att-value='billing_phone' />
                <input type="hidden" name='x_email' t-att-value="billing_email" />
                <input type="hidden" name='x_state' t-att-value="billing_state" />
                <!-- Shipping Information-->
                <input
                    type="hidden"
                    name='x_ship_to_first_name'
                    t-att-value="first_name"
                />
                <input
                    type="hidden"
                    name='x_ship_to_last_name'
                    t-att-value="last_name"
                />
                <input type="hidden" name='x_ship_to_address' t-att-value="address" />
                <input type="hidden" name='x_ship_to_city' t-att-value="city" />
                <input type="hidden" name='x_ship_to_zip' t-att-value="zip_code" />
                <input type="hidden" name='x_ship_to_country' t-att-value="country" />
                <input type="hidden" name='x_ship_to_phone' t-att-value='phone' />
                <input type="hidden" name='x_ship_to_email' t-att-value="email" />
                <input type="hidden" name='x_ship_to_state' t-att-value="state" />
            </div>
        </template>

        <template id="pagseguro_s2s_form">
             <script>
                function onChangePaymentMethod() {
                    if (document.getElementById("payment_form").value === "CREDIT_CARD") {
                        document.getElementById("installments").style.visibility = "visible";
                        document.getElementById("installmentsvalue").style.visibility = "visible";
                        document.querySelector("div > div.row.mt8 > div:nth-child(2) > label").style.visibility = 'visible';
                        document.querySelector("div > div.row.mt8 > div:nth-child(3) > label").style.visibility = 'visible';

                    } else {
                        document.getElementById("installments").style.visibility = "hidden";
                        document.getElementById("installmentsvalue").style.visibility = "hidden";
                        document.querySelector("div > div.row.mt8 > div:nth-child(2) > label").style.visibility = 'hidden';
                        document.querySelector("div > div.row.mt8 > div:nth-child(3) > label").style.visibility = 'hidden';
                    }
                }

                function onChangeInstallments() {
                    const number = document.getElementById("installments").value;
                    const table_of_factors = {
                        1: 1,
                        2: 0.51495,
                        3: 0.3467,
                        4: 0.26255,
                        5: 0.2121,
                        6: 0.17847,
                        7: 0.15446,
                        8: 0.13645,
                        9: 0.12246,
                        10: 0.11127,
                        11: 0.10212,
                        12: 0.0945,
                    };
                    const price_element = document.querySelector(
                        "#order_total > td.text-xl-right > strong > span"
                    );
                    const total_price = price_element.innerHTML.replace(",", ".").replace(".", "");
                    const installment_value = table_of_factors[number] * Number(total_price);
                    document.getElementById("installmentsvalue").value = convert_to_currency(
                        installment_value
                    );
                }

                function convert_to_currency(value) {
                    const converted = value.toLocaleString("pt-BR", {style: "currency", currency: "BRL"});
                    return converted;
                }
            </script>
            <input
                type="hidden"
                name="data_set"
                data-create-route="/payment/pagseguro/s2s/create_json_3ds"
            />
            <div
                t-attf-class="row mt8 #{'' if bootstrap_formatting else 'o_card_brand_detail'}"
            >
                <div
                    t-att-class="'form-group col-lg-5' if bootstrap_formatting else 'form-group'"
                >
                    <label for="payment_form">Payment form</label>
                    <select
                        name="payment_form"
                        id="payment_form"
                        placeholder="Payment method"
                        class="form-control"
                        onchange="onChangePaymentMethod()"
                    >
                        <option value="CREDIT_CARD">Credit Card</option>
                        <option value="BOLETO">Bill</option>
                    </select>
                </div>
                <div
                    t-att-class="'form-group col-lg-4' if bootstrap_formatting else 'form-group'"
                >
                    <label for="installments">Installments</label>
                    <select
                        name="installments"
                        id="installments"
                        class="form-control"
                        onchange="onChangeInstallments()"
                    >
                        <t
                            t-set="acquirer"
                            t-value="env['payment.acquirer'].search([('provider', '=', 'pagseguro')])"
                        />
                        <t
                            t-set="options"
                            t-value="acquirer.get_installments_options()"
                        />
                        <t t-foreach="options" t-as="i">
                            <option>
                                <t t-esc="i" />
                            </option>
                        </t>
                    </select>
                </div>
                <div
                    t-att-class="'form-group col-lg-3' if bootstrap_formatting else 'form-group'"
                >
                    <label for="installments">Value per installment</label>
                    <input
                        id="installmentsvalue"
                        type="text"
                        name="installmentsvalue"
                        readOnly="false"
                        class="form-control"
                    />
                </div>
                <div
                    t-att-class="'form-group col-lg-12' if bootstrap_formatting else 'form-group'"
                >
                    <input
                        type="tel"
                        name="cc_number"
                        id="cc_number"
                        class="form-control"
                        placeholder="Card number"
                        data-is-required="true"
                    />
                    <div class="card_placeholder" />
                    <div class="visa" />
                    <input type="hidden" name="cc_brand" />
                </div>
                <div
                    t-att-class="'form-group col-lg-5' if bootstrap_formatting else 'form-group'"
                >
                    <input
                        type="text"
                        name="cc_holder_name"
                        id="cc_holder_name"
                        class="form-control"
                        placeholder="Cardholder name"
                        data-is-required="true"
                    />
                </div>
                <div
                    t-att-class="'form-group col-lg-4' if bootstrap_formatting else 'form-group'"
                >
                    <input
                        type="text"
                        name="cc_expiry"
                        id="cc_expiry"
                        class="form-control"
                        maxlength="9"
                        placeholder="Expires (MM/YYYY)"
                        data-is-required="true"
                    />
                </div>
                <div
                    t-att-class="'form-group col-lg-3' if bootstrap_formatting else 'form-group'"
                >
                    <input
                        type="text"
                        name="cc_cvc"
                        id="cc_cvc"
                        class="form-control"
                        maxlength="4"
                        placeholder="CVC"
                        data-is-required="true"
                    />
                </div>
            </div>
            <input type="hidden" name="acquirer_id" t-att-value="id" />
            <input type="hidden" name="cc_token" />
            <input
                class="d-none"
                name="csrf_token"
                t-att-value="request.csrf_token()"
            />
            <div id="payment-form">
                <div id="card-element" class="m-3" />
                <div id="card-errors" class="m-3 text-danger" />
            </div>
            <xpath expr="//input[@name='data_set']" position="replace" />
            <input
                t-if="return_url"
                type="hidden"
                name="return_url"
                t-att-value="return_url"
            />
            <input
                t-if="partner_id"
                type="hidden"
                name="partner_id"
                t-att-value="partner_id"
            />
        </template>
    </data>
</odoo>
