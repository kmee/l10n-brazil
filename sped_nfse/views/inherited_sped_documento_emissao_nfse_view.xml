<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright 2017 KMEE
     License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl). -->

<odoo>
    <data>

        <record model="ir.ui.view" id="sped_documento_form_view">
            <field name="name">sped.documento.form (in sped_nfse)</field>
            <field name="model">sped.documento</field>
            <field name="inherit_id"
                   ref="sped.sped_documento_emissao_nfse_form"/>
            <field name="arch" type="xml">
                <xpath expr="//sheet[1]" position="before">
                    <header>
                        <button name="envia_nfe" string="Enviar NFS-e"
                                type="object" class="btn-primary"
                                attrs="{'invisible': [('situacao_nfe', 'not in', ['em_digitacao', 'rejeitada'])]}"/>
                        <button name="envia_email" string="Enviar email"
                                type="object" class="btn-primary"/>
                        <button name="gera_pdf" string="Gerar PDF" type="object"
                                class="btn-primary"/>
                        <button name="consulta_nfse" string="Consultar NFSe"
                                type="object" class="btn-primary"
                                attrs="{'invisible': [('situacao_nfe', '!=', 'enviada')]}"/>
                    </header>
                </xpath>
                <xpath expr="//field[@name='empresa_id']" position="before">
                    <field name="situacao_nfe" readonly="1" colspan="4"
                           string="Situação"
                           decoration-warning="situacao_nfe == 'denegada' or situacao_fiscal == '04'"
                           decoration-danger="situacao_nfe == 'rejeitada'"
                    />
                    <field name="mensagem_nfe" readonly="1" colspan="4"
                           attrs="{'invisible': [('situacao_nfe', '!=', 'rejeitada')]}"
                           decoration-warning="situacao_nfe == 'denegada' or situacao_fiscal == '04'"
                           decoration-danger="situacao_nfe == 'rejeitada'"
                    />
                </xpath>
                <xpath expr="//field[@name='operacao_id']" position="after">
                    <field name="natureza_tributacao_nfse" colspan="4"/>
                </xpath>
                <page name="financeiro" position="after">
                    <page name="detalhe_nfse" string="NFS-e">
                        <field name="permite_cancelamento" invisible="1"/>
                        <group col="4"
                               attrs="{'invisible': [('permite_cancelamento', '=', False), ('situacao_nfe', '!=', 'cancelada')]}">
                            <separator string="Cancelamento" colspan="4"/>
                            <field name="justificativa" colspan="4"
                                   attrs="{'readonly': [('situacao_nfe', '=', 'cancelada')]}"/>
                            <button name="cancela_nfse" string="Cancelar NFS-e"
                                    type="object" class="btn-primary"
                                    attrs="{'invisible': ['|', ('permite_cancelamento', '=', 'False'), ('situacao_nfe', '!=', 'autorizada')]}"/>
                        </group>
                    </page>
                    <page name="suporte" string="Suporte">
                        <group col="4">
                            <separator string="Autorização" colspan="4"/>
                            <field name="data_hora_autorizacao"/>
                            <field name="protocolo_autorizacao"/>
                            <field name="arquivo_xml_id" colspan="4"
                                   string="NF-e"/>
                            <field name="arquivo_xml_autorizacao_id" colspan="4"
                                   string="Processo"/>
                            <field name="arquivo_pdf_id" colspan="4"
                                   string="DANFE"/>
                        </group>
                        <group col="4"
                               attrs="{'invisible': [('situacao_nfe', '!=', 'cancelada')]}">
                            <separator string="Cancelamento" colspan="4"/>
                            <field name="data_hora_cancelamento"/>
                            <field name="protocolo_cancelamento"/>
                            <field name="arquivo_xml_cancelamento_id"
                                   colspan="4" string="Cancelamento"/>
                            <field name="arquivo_xml_autorizacao_cancelamento_id"
                                   colspan="4" string="Autorização"/>
                        </group>
                    </page>
                </page>
            </field>
        </record>


        <record model="ir.ui.view" id="sped_documento_tree_view">
            <field name="name">sped.documento.tree (in sped_nfse)</field>
            <field name="model">sped.documento</field>
            <field name="inherit_id"
                   ref="sped.sped_documento_emissao_nfse_tree"/>
            <field name="arch" type="xml">
                <xpath expr="//tree[1]" position="attributes">
                    <!-- Muda a cor para:
                            muted (cinza): cancelada ou inutilizada, ou mercadoria não circulou ou não recebida
                            warning (marrom cocô): denegada
                            info (azul petróleo): aguardando envio para SEFAZ
                            primary (lilás/roxinho): aguardando resposta da SEFAZ
                            danger (vermelho): rejeitada
                            success (verde):
                    -->
                    <attribute name="decoration-warning">situacao_nfe ==
                        'denegada' or situacao_fiscal == '04'
                    </attribute>
                    <attribute name="decoration-muted">situacao_nfe in
                        ('cancelada', 'inutilizada') or situacao_fiscal in
                        ('02', '03', '05', 'NC', 'MR')
                    </attribute>
                    <attribute name="decoration-info">situacao_nfe ==
                        'a_enviar'
                    </attribute>
                    <attribute name="decoration-primary">situacao_nfe ==
                        'enviada'
                    </attribute>
                    <attribute name="decoration-danger">situacao_nfe ==
                        'rejeitada'
                    </attribute>
                </xpath>
                <xpath expr="//field[@name='empresa_id']" position="before">
                    <field name="situacao_nfe" string="Situação"/>
                </xpath>
            </field>
        </record>


    </data>
</odoo>
